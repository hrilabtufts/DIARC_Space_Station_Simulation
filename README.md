# DIARC Unity Space Station Simulation

This project contains the DIARC space station simulation comprised of two executables and a script for launching the docker containers and services required to simulate a PR2 running DIARC.

### Unity Server

The server build connects to the virtual PR2 via RosBridge and DIARC. 
It allows one or more client to connect to it and interact with the robot.

This requires a `server-settings.json`

* [Space Station Server v3.5.91 - Latest]()

### Unity Client

The client build connects to the Unity server and provides the user interaction. 
When using a[Vive Pro Eye](https://www.vive.com/sea/product/vive-pro-eye/overview/) and with the [SRanipal](https://docs.vrcft.io/docs/hardware/VIVE/sranipal) eye tracking software installed, user eye gaze and pupil size will be tracked by the application.

* [Space Station Client v5.5.50 - Latest]()

### Script Dependencies

* [docker](https://docs.docker.com/engine/install/ubuntu/)
* [docker compose](https://docs.docker.com/compose/install/linux/)


### Script Usage

```
Usage: usd [command] <options>
Commands:
  build   - Build this container with optional -f/--force arguments for forcing re-build of entire image
  run     - Run container: usd run <UNITY SERVER IP> [GUI ON]
  dev     - Run container in development mode: usd dev <LOCAL REPO PATH> [GUI ON]
  stop    - Gracefully bring down container. Not needed for docker compose commands run and dev.
  kill    - Ungracefully bring down container. Not needed for docker compose commands run and dev.
```

### Configuration

A `.env` file defines all of the environment variables needed to launch the space station simulation on your machine or network.
It must be created in this project directory and available to all scripts.

Example, also found in default.env:

```
BIN="docker compose"
UNITY_IP="127.0.0.1"
DIARC_CONFIG="edu.tufts.hrilab.config.unity.UnityDIARCSpaceStation"
WAIT=40
```

`BIN` is the command that will be used to launch the docker-compose.yaml file that is generated by this script.
If your system requires root to run this command it should be changed to `sudo docker compose`.
If you have installed the `docker-compose` script instead of the plugin, it should be changed to `docker-compose` or `sudo docker-compose` if your system requires root to launch containers.

`UNITY_IP` is the IP address of the machine the Unity server build is running on.
If this is a separate machine from the one running these docker containers it should have the port 1755 is open for network connections.

`DIARC_CONFIG` is the configuration file to launch on startup.
If you are developing your own DIARC configuration, change this value to point to your new class.

`WAIT` is the time, in seconds, between starting up ROS and starting up DIARC during which the Unity server needs to be started.

### Script Commands

#### build

The docker image must be built before the container with DIARC can be launched.

```bash
bash usd.sh build
```

In the case that your docker installation requires root to run:

```bash
sudo bash usd.sh build
```

#### run

Run DIARC and ROS on localhost.
This will start a single container with the diarc configuration.
Robot will connect to `127.0.0.1:8000` on the Unity server and publish a Rosbridge websocket server on port `9090`.

If your docker installation requires root to run, do not run this command with `sudo`, instead update your `.env` file's `BIN` variable to be `sudo docker compose` or `sudo docker-compose` as needed.

```bash
bash usd.sh run
```
This will start and launch associated ROS and DIARC.

```bash
bash usd.sh run
```

#### dev

Run DIARC in debug mode and use a development repository which can be edited locally.
This will rebuild the `unity` component in `../local_ade_repo` and launch DIARC with debug port `5005` expecting a connection from IntelliJ to start DIARC.

```bash
bash usd.sh dev ../diarc
```


### Configuring Unity Space Station Server


### Configuring Unity Space Station Client